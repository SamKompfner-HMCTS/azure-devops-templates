parameters:
  vstsFeedId: '0bb8fdf9-08cc-423c-8a96-81a1e4d65711'
  pool: 'Azure-VSTS-VS2017'
  azureSubscription: 'Reform-CFT-VH-Dev'
  buildConfiguration: 'Release'
  sonarCloudProjectKey: ''
  sonarCloudextraProperties: ''
  coverletCoverageExclusions: '[Hearings.DAL]*,[Testing.Common]*,[NUnit3.TestAdapter]*'
  solutionType: ''
  KeyVaultName: ''
  SecretsFilter: ''
  
jobs:
- job: 
  displayName: 'Build & Test Java Script and .Net Core'
  pool: ${{ parameters.pool }}

  # Reference templae for setting up build tools
  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    clean: false  # whether to fetch clean each time
  - template: ../templates/common/common.yml

# Performs npm steps - install, build, test, test publishing
  - template: ../templates/npm/npm.yml

# SonarCloud Prepare step
  - template: ../templates/sonarCloud/sonarCloudPrepare.yml
    parameters:
      sonarCloudProjectKey: ${{ parameters.sonarCloudProjectKey }}
      sonarCloudprojectName: '$(Build.Repository.Name)'
      sonarCloudextraProperties: ${{ parameters.sonarCloudextraProperties }}

# Restore NuGet packages and build VS solution
  - template: ../templates/vsBuild/vsBuild.yml
    parameters:
      buildConfiguration: '${{ parameters.buildConfiguration }}'

# Get secrets from Key Vault
  - template: ../templates/getSecrets/getSecrets.yml
    parameters:
        azureSubscription: '${{ parameters.azureSubscription }}'
        KeyVaultName: '${{ parameters.KeyVaultName }}'
        SecretsFilter: '${{ parameters.SecretsFilter }}'

  # Executes unit tests
  - template: ../templates/tests/runUnitTests.yml
    parameters:
      buildConfiguration: '${{ parameters.buildConfiguration }}'
      coverletCoverageExclusions: '${{ parameters.coverletCoverageExclusions }}'

# Executes tests and publishes results
  - template: ../templates/tests/runIntegrationTests.yml
    parameters:
      buildConfiguration: '${{ parameters.buildConfiguration }}'
      coverletCoverageExclusions: '${{ parameters.coverletCoverageExclusions }}'

# Executes tests and publishes results
#  - template: ../templates/sonarCloud/sonarCloudRunAnalysis.yml

# Publish artifacts
  - template: ../templates/publishArtifacts/publishArtifacts.yml
