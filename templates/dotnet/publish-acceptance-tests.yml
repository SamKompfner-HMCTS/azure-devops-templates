parameters:
  - name: vstsFeedId
    type: string
    default: ''

  - name: useNugetConfig
    type: boolean
    default: false

  - name: coreProjectPath
    type: string

  - name: nugetProjectPath
    type: string
    default: ''

  - name: nugetConfigPath
    type: string
    default: ''

  - name: packageManagers
    type: object
    default:
     - nuget

  - name: Test
    type: boolean
    default: false

  - name: netVersion
    type: string
    default: '3.1.x'

steps:
- checkout: self

- powershell: |
    Write-Host "##vso[task.setvariable variable=BuildNum;]$(Build.BuildNumber)"
    Write-Host "$(Build.BuildNumber)"
  displayName: Get BuildNumber

# Install .NET 5 for Git Version.
- task: UseDotNet@2
  displayName: 'Install .NET 5.x SDK'
  inputs:
    packageType: sdk
    version: 5.x
    installationPath: $(Agent.ToolsDirectory)/dotnet
    
- task: gitversion/setup@0
  displayName: Install Git Version
  inputs:
    versionSpec: '5.6.0'

- bash: |
    dotnet-gitversion /output json /output buildserver /updateassemblyinfo ${{ parameters.coreProjectPath }}.AcceptanceTests/AssemblyInfo.cs /ensureassemblyinfo
  displayName: Determine Version for Acceptance Tests

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK'
  inputs:
    packageType: sdk
    version: ${{ parameters.netVersion }}
    installationPath: $(Agent.ToolsDirectory)/dotnet

- task: DotNetCoreCLI@2
  displayName: dotnet restore
  inputs:
    command: restore
    projects: '**/*AcceptanceTests.csproj'
    restoreArguments: --force-evaluate
    ${{ if eq(parameters.useNugetConfig, true) }}:
      feedsToUse: config
      nugetConfigPath: ${{ parameters.nugetConfigPath }}/nuget.config
    ${{ if eq(parameters.useNugetConfig, false) }}:
      vstsFeed: ${{ parameters.vstsFeedId }}
      includeNuGetOrg: true

- task: DotNetCoreCLI@2
  displayName: donet publish
  inputs:
    command: publish
    publishWebProjects: false
    arguments: --configuration Release --output $(build.artifactstagingdirectory)/AcceptanceTests
    zipAfterPublish: false
    workingDirectory: ${{ parameters.coreProjectPath }}.AcceptanceTests

- task: PublishBuildArtifacts@1
  displayName: Publish Acceptance Tests
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)/AcceptanceTests
    ArtifactName: AcceptanceTests

- powershell: |
    Write-Host "##vso[build.updatebuildnumber]$(BuildNum)"
  displayName: Set Build.BuildNumber