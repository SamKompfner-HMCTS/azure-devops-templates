parameters:
  - name: subscriptionName
    type: string
  - name: resourceName
    type: string
  - name: resourceLocation
    type: string

  - name: variableName
    type: string
  - name: taskName
    type: string
    default: 'getSoftDeleteServices'


steps:
  - task: AzureCLI@2
    displayName: 'Check if ${{ parameters.resourceName }} is available'
    name: ${{ parameters.taskName }}
    inputs:
      azureSubscription: '${{ parameters.subscriptionName }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |

        subId=$(az account show --query "id" -o tsv)
        echo "Subscription ID: ${subId}"
        
        restUrl="https://management.azure.com/subscriptions/${subId//[$'\t\r\n']}/providers/Microsoft.ApiManagement/locations/${resourceLocation//[$'\t\r\n']}/deletedservices/${resourceName//[$'\t\r\n']}?api-version=2020-06-01-preview"
        echo "Calling: ${restUrl}"
        
        response=$(az rest --method GET --uri ${restUrl} --query "id" -o tsv)
        echo "Response: $response"
        
        available=true
        if [[ $response == "" ]]; then
          available=false
        fi
        echo "##vso[task.setvariable variable=${variableName};isOutput=true]${available}"
      
    env:
      variableName: "${{ parameters.variableName }}"
      resourceLocation: "${{ parameters.resourceLocation }}"
      resourceName: "${{ parameters.resourceName }}"
