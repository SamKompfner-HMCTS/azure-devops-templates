parameters:
  buildConfiguration: '' # used in DotNetColeCLI tasks

  - task: MagicChunks@2
    displayName: 'Config transform for Integration tests'
    inputs:
      sourcePath: '**\*IntegrationTests\bin\${{ parameters.buildConfiguration }}\**\appsettings.json'
      transformations: |  
       {
       "KeyVaultSettings/KeyVaultUri": "$(VHAzureKeyVault)",
       "KeyVaultSettings/ClientId": "$(vh-website-AppID)",
       "KeyVaultSettings/ClientSecret": "$(vh-website-Key)"
       }
  
  - task: DotNetCoreCLI@2
    displayName: 'Run Integration tests'
    inputs:
      command: test
      projects: '**\**\*IntegrationTests.csproj'
      arguments: '--no-build /p:CollectCoverage=true /p:CoverletOutputFormat="\"opencover,cobertura,json\"" /p:Exclude="\"[NUnit3.TestAdapter]*\"" /p:CoverletOutput=$(Common.TestResultsDirectory)\Coverage\ -c ${{ parameters.buildConfiguration }} '
  
  - task: PublishCodeCoverageResults@1
    displayName: 'Publish code coverage'
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(Common.TestResultsDirectory)\Coverage\coverage.cobertura.xml'
      reportDirectory: '$(Common.TestResultsDirectory)\Coverage\Reports'
      failIfCoverageEmpty: true
  
  - task: SonarCloudAnalyze@1
    displayName: 'Run Code Analysis'
  
  - task: SonarCloudPublish@1
    displayName: 'Publish Quality Gate Result'