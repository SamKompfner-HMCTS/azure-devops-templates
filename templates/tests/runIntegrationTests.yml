parameters:
  buildConfiguration: '' # used in DotNetCoreCLI tasks
  coverletCoverageExclusions: ''
  integrationTestsAppSettingsTransform: ''

steps:
  - task: MagicChunks@2
    displayName: 'Config transform for Integration tests'
    inputs:
      sourcePath: '**\*IntegrationTests\bin\**\**\appsettings.json'
      transformations: |  
       {
        ${{ parameters.integrationTestsAppSettingsTransform }}
       }
  
  - task: DotNetCoreCLI@2
    displayName: 'Run Integration tests'
    inputs:
      command: test
      projects: '**\**\*IntegrationTests.csproj'
      arguments: '--no-build /p:CollectCoverage=true /p:CoverletOutputFormat="\"opencover,cobertura,json\"" /p:Exclude="\"${{ parameters.coverletCoverageExclusions }}\"" /p:CoverletOutput=$(Common.TestResultsDirectory)\Coverage\ -c ${{ parameters.buildConfiguration }} /p:MergeWith=$(Common.TestResultsDirectory)\Coverage\coverage.json '
  
  - task: PublishCodeCoverageResults@1
    displayName: 'Publish code coverage'
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(Common.TestResultsDirectory)\Coverage\coverage.cobertura.xml'
      reportDirectory: '$(Common.TestResultsDirectory)\Coverage'
      failIfCoverageEmpty: true
