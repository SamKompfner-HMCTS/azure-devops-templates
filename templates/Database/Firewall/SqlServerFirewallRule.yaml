parameters:
  - name: sqlServerName
    type: string

  - name: sqlServerResourceGroup
    type: string

  - name: addFirewallRule
    type: string
    default: null

  - name: removeFirewallRule
    type: string
    default: null

  - name: azureSubscription
    type: string

steps:
    - task: AzureCLI@2
      name: AddFirewallRule
      condition: ne('${{ parameters.addFirewallRule }}', 'null')
      displayName: Add SQL Firewall Rule
      continueOnError: false
      inputs:
        azureSubscription: ${{ parameters.azureSubscription }}
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
          $ruleName = "AzureDevOpsRule-$(Build.BuildId)"
          $publicIp = (Invoke-WebRequest -uri "http://ifconfig.me/ip").Content
          $sqlServer = "${{ parameters.sqlServerName }}"
          $sqlResourceGroup = "${{ parameters.sqlServerResourceGroup }}"

          az sql server firewall-rule create -g $sqlResourceGroup  -s $sqlServer -n $ruleName  --start-ip-address $publicIp --end-ip-address $publicIp

          $check = az sql server firewall-rule list -g $sqlResourceGroup  -s $sqlServer

          if ($check -like "*$ruleName*") {
            Write-Host "##vso[task.setvariable variable=fwRuleAdded;isOutput=true]yes"
          }
          else {
            Write-Error "##[error]Failed To Add Firewall Rule To SQL Server..."
            exit (0)
          }

    - task: AzureCLI@2
      name: RemoveFirewallRule
      displayName: Remove SQL Firewall Rule
      continueOnError: false
      condition: ne('${{ parameters.removeFirewallRule }}', 'null')
      inputs:
        azureSubscription: ${{ parameters.azureSubscription }}
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
          $ruleName = "AzureDevOpsRule-$(Build.BuildId)"
          $sqlServer = "${{ parameters.sqlServerName }}"
          $sqlResourceGroup = "${{ parameters.sqlServerResourceGroup }}"

          az sql server firewall-rule delete -g $sqlResourceGroup  -s $sqlServer -n $ruleName
